{"version":3,"file":"_server-d5937346.js","sources":["../../../../src/routes/login/callback/+server.js"],"sourcesContent":["import jsonwebtoken from 'jsonwebtoken';\nconst { sign } = jsonwebtoken;\nimport { redirect } from '@sveltejs/kit';\nimport { env } from '$env/dynamic/private';\n\nexport async function GET({ url, cookies }) {\n\tlet query = url.searchParams.get('code');\n\tif (!query) return new Response('The code was not found in the request', { status: 400 });\n\n\t//authorize with github\n\tlet token = await fetch(\n\t\t`https://github.com/login/oauth/access_token?client_id=${env.GITHUB_CLIENT_ID}&client_secret=${env.GITHUB_CLIENT_SECRET}&code=${query}`,\n\t\t{\n\t\t\tmethod: 'POST',\n\t\t\theaders: {\n\t\t\t\t'Content-Type': 'application/json',\n\t\t\t\tAccept: 'application/json'\n\t\t\t}\n\t\t}\n\t).then((res) => res.json());\n\tif (!token.access_token)\n\t\treturn new Response('The access token was not found in the response', { status: 400 });\n\n\t//get user data\n\tlet user = await fetch('https://api.github.com/user', {\n\t\theaders: {\n\t\t\tAuthorization: `token ${token.access_token}`\n\t\t}\n\t}).then((res) => res.json());\n\tif (user.message === 'Bad credentials') {\n\t\treturn new Response('The generated token was invalid', { status: 400 });\n\t}\n\n\t//get emails\n\tlet emails = await fetch('https://api.github.com/user/emails', {\n\t\theaders: {\n\t\t\tAuthorization: `token ${token.access_token}`\n\t\t}\n\t}).then((res) => res.json());\n\tif (emails.message === 'Bad credentials') {\n\t\treturn new Response('The generated token was invalid', { status: 400 });\n\t}\n\n\t//create a jwt\n\tlet jwt = sign(\n\t\t{\n\t\t\tuser: user,\n\t\t\ttoken: token.access_token,\n\t\t\temails: emails\n\t\t},\n\t\tenv.JWT_SECRET,\n\t\t{\n\t\t\texpiresIn: '8h'\n\t\t}\n\t);\n\n\t//set the cookie\n\tcookies.set('jwt', jwt, {\n\t\thttpOnly: true,\n\t\tpath: '/',\n\t\tmaxAge: 60 * 60 * 8\n\t});\n\tcookies.set('welcome', true, {\n\t\thttpOnly: false,\n\t\tpath: '/',\n\t\tmaxAge: 60 * 60 * 8\n\t});\n\n\tif (url.searchParams.get('next')) throw redirect(303, url.searchParams.get('next'));\n\telse throw redirect(303, '/');\n}\n"],"names":["env"],"mappings":"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"}